pipeline {
    agent any
    environment {
        IMAGE_NAME = 'kahanhm/flask-mongo-app'
        DOCKER_REGISTRY = 'https://index.docker.io/v1/' 
    }
    stages {
        // Step 1: Clone or Pull Repo
        stage('Clone or Pull Repo') {
            steps {
                script {
                    if (fileExists('python-App-for-CICD')) {
                        echo 'Repository already exists, pulling latest changes...'
                        sh 'cd python-App-for-CICD && git pull origin main'
                    } else {
                        echo 'Cloning the repository...'
                        sh 'git clone https://github.com/KahanHM/python-App-for-CICD.git'
                    }
                }
            }
        }

        // Step 2: Check if Python is installed, if not install it
        stage('Check and Install Python') {
            steps {
                script {
                    def pythonInstalled = sh(script: 'python3 --version', returnStatus: true)
                    if (pythonInstalled != 0) {
                        echo 'Python is not installed, installing Python...'
                        sh 'sudo apt-get update && sudo apt-get install -y python3'
                    } else {
                        echo 'Python is already installed.'
                    }
                }
            }
        }

        // Step 3: Check if Docker is installed, if not install it
        stage('Check and Install Docker') {
            steps {
                script {
                    def dockerInstalled = sh(script: 'docker --version', returnStatus: true)
                    if (dockerInstalled != 0) {
                        echo 'Docker is not installed, installing Docker...'
                        sh '''
                        sudo apt-get update
                        sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common
                        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
                        sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
                        sudo apt-get update
                        sudo apt-get install -y docker-ce
                        sudo usermod -aG docker $USER
                        '''
                    } else {
                        echo 'Docker is already installed.'
                    }
                }
            }
        }

       

        // Step 5: Build Docker image
        stage('Build Docker Image') {
            steps {
                script {
                    echo 'Building Docker Image...'
                    sh '''
                    cd python-App-for-CICD/flask-mongo-app
                    sudo docker build -t $IMAGE_NAME .
                    '''
                }
            }
        }
        stage('Push to Docker Hub') {
            steps {
                withDockerRegistry([credentialsId: 'docker-hub-credentials', url: 'DOCKER_REGISTRY']) {
                    sh 'docker push $IMAGE_NAME'
                }
            }
        }
        // stage('Deploy to EC2') {
        //     steps {
        //         sshagent(['ec2-ssh-key']) {
        //             sh '''
        //             ssh ubuntu@your-ec2-ip <<EOF
        //             docker pull $IMAGE_NAME
        //             docker stop flask-app || true
        //             docker rm flask-app || true
        //             docker run -d -p 5000:5000 --name flask-app --link mongo:mongo $IMAGE_NAME
        //             sudo iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 5000
        //             EOF
        //             '''
        //         }
        //     }
        }
    }
// }
